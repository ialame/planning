services:
  # Database Service
  db:
    image: mariadb:10.6
    container_name: pokemon-db
    environment:
      MARIADB_DATABASE: pokemon_planning
      MARIADB_USER: pokemon_user
      MARIADB_PASSWORD: pokemon_password
      MARIADB_ROOT_PASSWORD: root_password
    volumes:
      - db_data:/var/lib/mysql
    ports:
      - "8011:3306"
    networks:
      - pokemon-network
    healthcheck:
      test: ["CMD", "healthcheck.sh", "--connect", "--innodb_initialized"]
      interval: 10s
      timeout: 5s
      retries: 3

  # Backend Service (Spring Boot)
  backend:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: pokemon-backend
    depends_on:
      db:
        condition: service_healthy
    environment:
      SPRING_DATASOURCE_URL: jdbc:mariadb://db:8011/pokemon_planning
      SPRING_DATASOURCE_USERNAME: pokemon_user
      SPRING_DATASOURCE_PASSWORD: pokemon_password
      SERVER_PORT: 8010
      # Allow frontend to access API
      CORS_ALLOWED_ORIGINS: http://localhost:3000
    ports:
      - "8010:8080"
    networks:
      - pokemon-network
    restart: on-failure

  # Frontend Service (Vue.js + Nginx)
  frontend:
    build:
      context: ./src/main/frontend
      dockerfile: Dockerfile
    container_name: pokemon-frontend
    ports:
      - "8012:3000"
    environment:
      # This env var is used during build time in some setups,
      # but since it's an SPA, the browser needs to reach localhost:8010
      VITE_API_BASE_URL: http://localhost:8010
    networks:
      - pokemon-network
    depends_on:
      - backend

volumes:
  db_data:

networks:
  pokemon-network:
    driver: bridge
